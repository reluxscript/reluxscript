# TDD Test Results - ReluxScript Minimal Tests

## Test Summary

**Date:** 2025-11-26
**Total Tests:** 6
**Passed:** 2
**Failed:** 4

---

## ✅ PASSING TESTS

### 1. Path Expressions
**Status:** PASS
**File:** `test_path_expressions.lux`

All checks passed:
- ✅ codegen::generate uses `::`
- ✅ fs::read_to_string uses `::`

**Conclusion:** Path expression fix is working correctly.

---

### 2. Pattern Matching
**Status:** PASS
**File:** `test_pattern_matching.lux`

All checks passed:
- ✅ Pat::Array qualification
- ✅ Pat::Object qualification
- ✅ Pat::Ident qualification
- ✅ Expr::Call qualification
- ✅ Expr::Member qualification
- ✅ Stmt::Return qualification
- ✅ Stmt::If qualification

**Conclusion:** Pattern variant qualification fix is working correctly.

---

## ❌ FAILING TESTS

### 3. Macro Calls
**Status:** FAIL
**File:** `test_macro_calls.lux`
**Error:** `Parse error at 10:16: Expected Semicolon`

**Issue:** Parser fails on line 10:
```reluxscript
println!("{}", msg);
```

**Root Cause:** Parser doesn't handle macro calls with `!` suffix. The lexer tokenizes `println` as Ident and `!` as Not, but the parser doesn't recognize this as a macro call pattern.

**Fix Needed:**
1. Parser needs to detect `Ident + Not + LParen` pattern
2. Parse it as a macro call expression
3. Store `is_macro` flag in AST or append `!` to function name

**Priority:** HIGH - Macros are used extensively in minimact

---

### 4. Named Imports from File Modules
**Status:** PARTIAL FAIL
**File:** `test_named_imports.lux`

**Passing:**
- ✅ Can call imported function (function calls work)

**Failing:**
- ❌ Expected pattern not found: `mod helpers;`
- ❌ Expected pattern not found: `use helpers::{escape_string, uppercase};`

**Issue:** The `emit_user_imports()` function was added to the emitter but the generated output doesn't contain the mod/use statements.

**Root Cause:** Need to verify:
1. Is `emit_user_imports()` actually being called?
2. Are the use statements in DecoratedProgram.uses?
3. Is the output being written before or after the imports?

**Actual Generated Output:**
```rust
// Generated by ReluxScript compiler
// Do not edit manually

use swc_common::{Span, DUMMY_SP, SyntaxContext};
use swc_ecma_ast::*;
use swc_ecma_visit::{VisitMut, VisitMutWith};

// Missing: mod helpers;
// Missing: use helpers::{escape_string, uppercase};

pub struct NamedImportsTest {}
// ...
```

**Fix Needed:**
1. Debug why `emit_user_imports()` isn't emitting anything
2. Check if DecoratedProgram.uses is populated correctly
3. Ensure the function detects file modules (starts with `./`)

**Priority:** HIGH - Critical for minimact's module system

---

### 5. Built-in Module Imports
**Status:** PARTIAL FAIL
**File:** `test_builtin_imports.lux`

**Passing:**
- ✅ codegen uses `::` (path expressions work)
- ✅ fs uses `::` (path expressions work)

**Failing:**
- ❌ Expected pattern not found: `use std::fs;`
- ❌ Expected pattern not found: `use serde_json;`

**Issue:** Built-in module imports (fs, json) are detected by `detect_imports()` and flags are set (`uses_fs = true`, `uses_json = true`), but the imports aren't being emitted in the header.

**Root Cause:** The `emit_header()` function has conditional imports for fs and json, but they might not be emitting correctly.

**Actual Generated Output:**
```rust
// Generated by ReluxScript compiler
// Do not edit manually

use swc_common::{Span, DUMMY_SP, SyntaxContext};
use swc_ecma_ast::*;
use swc_ecma_visit::{VisitMut, VisitMutWith};

// Missing: use std::fs;
// Missing: use std::path::Path;
// Missing: use serde_json;

pub struct BuiltinImportsTest {}
// ...
```

**Fix Needed:**
1. Verify `detect_imports()` is setting flags correctly
2. Check if `emit_header()` conditionals are working
3. Debug why imports aren't appearing in output

**Priority:** HIGH - Critical for minimact (uses fs and json extensively)

---

### 6. Minimact Patterns
**Status:** PARTIAL FAIL
**File:** `test_minimact_patterns.lux`

**Passing:**
- ✅ Pat::Array for array destructuring
- ✅ Pat::Ident for identifier patterns
- ✅ Nested if-let compiles

**Failing:**
- ❌ Expected pattern not found: `Stmt::Var`

**Issue:** Looking for `Stmt::Var` but it should be `Stmt::Decl` or another variant name.

**Root Cause:** Wrong expectation in test. Need to check what SWC actually uses for VariableDeclaration.

**Fix Needed:**
1. Check SWC AST for correct Statement variant name
2. Update test expectation
3. OR update mapping if ReluxScript isn't mapping correctly

**Priority:** LOW - Test expectation issue, not a compiler bug

---

## Summary of Issues to Fix

### Critical (Blocking minimact compilation):
1. **Parser doesn't handle macro calls** (`format!`, `println!`, etc.)
2. **File module imports not emitting** (mod/use statements missing)
3. **Built-in module imports not emitting** (fs, json imports missing)

### Actions Required:

#### Issue #1: Macro Parser Support
- [ ] Add parser support for `Ident + ! + (` pattern
- [ ] Either store `is_macro` flag or append `!` to identifier name
- [ ] Test with `format!`, `println!`, `vec!`, `panic!`

#### Issue #2: File Module Imports
- [ ] Debug `emit_user_imports()` - add logging to see if it's called
- [ ] Verify DecoratedProgram.uses contains file imports
- [ ] Check if imports are filtered out incorrectly
- [ ] Ensure output order is correct (imports before code)

#### Issue #3: Built-in Module Imports
- [ ] Debug `detect_imports()` - verify flags are set
- [ ] Debug `emit_header()` - verify conditionals execute
- [ ] Check if there's an early return preventing imports
- [ ] Add debug output to trace execution

---

## Next Steps

1. Fix macro parser support (highest priority - blocking)
2. Debug and fix import emission (file modules and built-in)
3. Update test expectations for statement variants
4. Re-run tests to verify fixes
5. Test with actual minimact files once all tests pass
